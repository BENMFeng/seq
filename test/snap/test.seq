from genomeindex import *
type K = k20

def has_N(s: seq):
    for i in range(len(s)):
        if s[i] == s'N':
            return True
    return False

def main(args: array[str]):
    index = GenomeIndex[K](args[0])
    hits0 = ptr[u32](1)
    rc_hits0 = ptr[u32](1)
    hits = ptr[ptr[u32]](hits0)
    rc_hits = ptr[ptr[u32]](rc_hits0)

    f = File(args[1], "r")
    line = -1
    checksum = u32(0)

    for s in f:
        line += 1
        if line % 4 != 1:
            continue

        for sub in s.split(K.len(), K.len()):
            if has_N(sub):
               continue

            kmer = K(sub)
            n_hits, n_rc_hits = index.lookup(kmer, hits, rc_hits)
            p1, p2 = hits[0], rc_hits[0]

            for i in range(n_hits):
                checksum ^= p1[0]

            for i in range(n_rc_hits):
                checksum ^= p2[0]

            hits[0] = hits0
            rc_hits[0] = rc_hits0

    print 'CHECKSUM:', int(checksum)

if len(__argv__) > 0:
    main(__argv__)
